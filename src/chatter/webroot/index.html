<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Sample of websocket with golang</title>
        <script src="vender/jquery-1.8.3.min.js"></script>
        <script src="vender/knockout-2.2.0.js"></script>
        <script src="vender/jquery.json-2.4.min.js"></script>
    <link rel="stylesheet" href="vender/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="vender/bootstrap/css/bootstrap-responsive.min.css">
		<script src="vender/bootstrap/js/bootstrap.min.js"></script>

		<script language="javascript" type="text/javascript">
            var getUri = "ws://localhost:22222/p2pGet";
            var addUri = "ws://localhost:22222/p2pAdd";
            var addWebSocket = null;
            var getWebSocket = null;
            var output;
            var documentId = null;

            function init() {
                output = document.getElementById("output");
                document.getElementById("createPage").onclick = function(evt) {
                    evt.preventDefault();
                    submitPageUsingSocket(evt);
                };
                documentId = getParameterByName("id");
                createWebSocket();
            }

            function submitPageUsingSocket(evt) {
                var author = document.getElementById("inputAuthor").value;
                var message = document.getElementById("inputBody").value;
                output.innerHTML = message;
                doSend(message);
            }

            function createWebSocket() {
                addWebSocket = new WebSocket(addUri);
                getWebSocket = new WebSocket(getUri);
                addWebSocket.onopen = function(evt) {
                    onOpen(evt)
                };
                addWebSocket.onclose = function(evt) {
                    onClose(evt)
                };
                addWebSocket.onmessage = function(evt) {
                    onMessage(evt)
                };
                addWebSocket.onerror = function(evt) {
                    onError(evt)
                };
                getWebSocket.onopen = function(evt) {
                    onOpen(evt)
                    if(documentId != "") {
                        getWebSocket.send(documentId);
                    }
                };
                getWebSocket.onclose = function(evt) {
                    onClose(evt)
                };
                getWebSocket.onmessage = function(evt) {
                    onMessage(evt)
                };
                getWebSocket.onerror = function(evt) {
                    onError(evt)
                };
            }

            function onOpen(evt) {
                log("CONNECTED");
            }

            function onClose(evt) {
                log("DISCONNECTED");
            }

            function onMessage(evt) {
                if(evt.data == "GetDocument") {
                    log("Sending Document");
                    doSend(output.innerHTML);
                } else {
                    document.getElementById("submit-form").remove();
                    document.getElementById("title").innerHTML = "Document...";
                    output.innerHTML = evt.data;
                }
            }

            function onError(evt) {
                log('<span style="color: red;">ERROR:</span> ' + evt.data);
            }

            function doSend(message) {
                addWebSocket.send(message);
            }

            function log(message) {
                console.log(message);
            }

            function getParameterByName(name) {
                name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
                return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
            }

			window.addEventListener("load", init, false);
		</script>
	</head>

	<body>

    <h2 id="title">Write Something...</h2>
	<div id="submit-form" class="grid-row">

		<div class="span3">
		</div>

		<div class="span6">
			<form class="well form-horizontal" data-bind="with: editingMessage">

				<!-- Author -->
				<div class="control-group">
					<label class="control-label" for="inputAuthor">Author :</label>
					<div class="controls">
						<input id="inputAuthor" name="author" type="text" data-bind="value: author"/>
					</div>
				</div>

				<!-- Body -->
				<div class="control-group">
					<label class="control-label" for="inputBody">Message :</label>
					<div class="controls">
						<textarea id="inputBody" name="text" data-bind="value: body">
						</textarea>
					</div>
				</div>

				<div class="control-group">
					<div class="controls">
                        <input id="createPage" type="submit" value="Submit" class="btn pull-right"/>
					</div>
				</div>
			</form>
		</div>
		</div>
    <div id="output"></div>
	</body>
</html>
